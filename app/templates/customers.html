{% extends "base.html" %}
{% block title %}Customers - Invoicing App{% endblock %}

{% block content %}
<div class="flex justify-between items-center mb-4">
  <h1 class="text-2xl font-semibold">Customers</h1>
</div>

<div class="grid grid-cols-1 md:grid-cols-3 gap-4">
  <!-- List -->
  <div class="md:col-span-2 bg-white shadow rounded p-4">
    <h2 class="text-lg font-semibold mb-2">Customer List</h2>
    <table class="w-full text-sm">
      <thead>
        <tr class="border-b">
          <th class="text-left py-2">Name</th>
          <th class="text-left py-2">Email</th>
          <th class="text-left py-2">Phone</th>
          <th class="text-center py-2">Actions</th>
        </tr>
      </thead>
      <tbody id="customersTableBody">
        <!-- filled by JS -->
      </tbody>
    </table>
  </div>

  <!-- Create / Edit form -->
  <div class="bg-white shadow rounded p-4">
    <h2 id="customerFormTitle" class="text-lg font-semibold mb-2">Add Customer</h2>
    <form id="customerForm" class="space-y-3 text-sm">
      <input type="hidden" id="customerId">
      <div>
        <label class="block mb-1">Name</label>
        <input id="custName" name="name" class="w-full border px-2 py-1 rounded" required>
      </div>
      <div>
        <label class="block mb-1">Email</label>
        <input id="custEmail" name="email" type="email" class="w-full border px-2 py-1 rounded">
      </div>
      <div>
        <label class="block mb-1">Phone</label>
        <input id="custPhone" name="phone" class="w-full border px-2 py-1 rounded">
      </div>
      <div>
        <label class="block mb-1">Address</label>
        <textarea id="custAddress" name="address" rows="3" class="w-full border px-2 py-1 rounded"></textarea>
      </div>
      <p id="customerError" class="text-xs text-red-600 hidden"></p>
      <div class="flex gap-2">
        <button class="flex-1 bg-blue-600 text-white rounded py-1.5 hover:bg-blue-700">
          <span id="customerSubmitLabel">Save</span>
        </button>
        <button type="button" id="customerCancelEdit"
                class="hidden flex-1 bg-gray-200 text-gray-800 rounded py-1.5 hover:bg-gray-300">
          Cancel
        </button>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  let customersCache = [];
  let editingCustomerId = null;

  function setCustomerFormMode(mode, customer = null) {
    const title = document.getElementById('customerFormTitle');
    const submitLabel = document.getElementById('customerSubmitLabel');
    const cancelBtn = document.getElementById('customerCancelEdit');
    const idInput = document.getElementById('customerId');
    const nameInput = document.getElementById('custName');
    const emailInput = document.getElementById('custEmail');
    const phoneInput = document.getElementById('custPhone');
    const addrInput = document.getElementById('custAddress');

    if (mode === 'edit' && customer) {
      editingCustomerId = customer.id;
      idInput.value = customer.id;
      nameInput.value = customer.name || '';
      emailInput.value = customer.email || '';
      phoneInput.value = customer.phone || '';
      addrInput.value = customer.address || '';
      title.textContent = 'Edit Customer';
      submitLabel.textContent = 'Update';
      cancelBtn.classList.remove('hidden');
    } else {
      editingCustomerId = null;
      idInput.value = '';
      nameInput.value = '';
      emailInput.value = '';
      phoneInput.value = '';
      addrInput.value = '';
      title.textContent = 'Add Customer';
      submitLabel.textContent = 'Save';
      cancelBtn.classList.add('hidden');
    }
  }

  async function fetchCustomers() {
    try {
      const res = await fetch('/customers');
      if (!res.ok) return;
      const data = await res.json();
      customersCache = data;
      const tbody = document.getElementById('customersTableBody');
      tbody.innerHTML = '';
      data.forEach(c => {
        const tr = document.createElement('tr');
        tr.className = 'border-b';
        tr.innerHTML = `
          <td class="py-1">${c.name}</td>
          <td class="py-1">${c.email || '-'}</td>
          <td class="py-1">${c.phone || '-'}</td>
          <td class="py-1 text-center space-x-2">
            <button data-id="${c.id}" class="edit-btn text-xs text-blue-600 hover:underline">Edit</button>
            <button data-id="${c.id}" class="delete-btn text-xs text-red-600 hover:underline">Delete</button>
          </td>
        `;
        tbody.appendChild(tr);
      });

      // Attach edit/delete handlers
      tbody.querySelectorAll('.edit-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = parseInt(btn.getAttribute('data-id'));
          const customer = customersCache.find(c => c.id === id);
          if (customer) setCustomerFormMode('edit', customer);
        });
      });

      tbody.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          const id = parseInt(btn.getAttribute('data-id'));
          if (!confirm('Delete this customer?')) return;
          try {
            const res = await fetch(`/customers/${id}`, { method: 'DELETE' });
            if (res.ok) {
              if (editingCustomerId === id) setCustomerFormMode('create');
              fetchCustomers();
            }
          } catch (err) {
            console.error(err);
          }
        });
      });
    } catch (err) {
      console.error(err);
    }
  }

  document.getElementById('customerForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const errorEl = document.getElementById('customerError');
    errorEl.classList.add('hidden');

    const payload = {
      name: document.getElementById('custName').value.trim(),
      email: document.getElementById('custEmail').value.trim() || null,
      phone: document.getElementById('custPhone').value.trim() || null,
      address: document.getElementById('custAddress').value.trim() || null,
    };

    const method = editingCustomerId ? 'PATCH' : 'POST';
    const url = editingCustomerId ? `/customers/${editingCustomerId}` : '/customers';

    try {
      const res = await fetch(url, {
        method,
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
      });

      const data = await res.json();
      if (!res.ok) {
        errorEl.textContent = data.error || 'Operation failed';
        errorEl.classList.remove('hidden');
        return;
      }

      setCustomerFormMode('create');
      fetchCustomers();
    } catch (err) {
      console.error(err);
      errorEl.textContent = 'Network error';
      errorEl.classList.remove('hidden');
    }
  });

  document.getElementById('customerCancelEdit').addEventListener('click', () => {
    setCustomerFormMode('create');
  });

  document.addEventListener('DOMContentLoaded', () => {
    setCustomerFormMode('create');
    fetchCustomers();
  });
</script>
{% endblock %}